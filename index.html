<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Meat Dept Spot Scanner</title>
  <style>
    body{font-family:Arial;margin:16px}
    video{width:100%;max-height:50vh;background:#000;border-radius:12px}
    button,select,input{font-size:18px;padding:10px}
    .big{font-size:36px;font-weight:bold;margin-top:10px}
    .panel{background:#f4f4f4;padding:12px;border-radius:12px;margin-top:10px}
    .status{background:#111;color:#fff;padding:8px;border-radius:10px;margin-top:8px;font-size:13px}
  </style>
</head>
<body>

<h2>Meat Dept Spot Scanner</h2>

<button onclick="startScan()">Start Scan</button>
<button onclick="stopScan()">Stop</button>

<video id="video" autoplay playsinline></video>

<div class="panel">
  <div class="big" id="spotText">Ready</div>
  <div id="descText"></div>
  <div id="upcText"></div>
</div>

<div id="assignPanel" class="panel" style="display:none;">
  <b>Assign Location</b>
  <div id="assignUpc"></div>
  Spot:
  <select id="spotSel">
    <option>1</option><option>2</option><option>3</option><option>4</option>
  </select>
  Zone:
  <select id="zoneSel">
    <option>A</option><option>B</option>
  </select>
  <input id="descInput" placeholder="Description"/>
  <button onclick="saveAssign()">Save</button>
</div>

<div class="status" id="statusText">Status: idle</div>

<script type="module">
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";

const video = document.getElementById("video");
const spotText = document.getElementById("spotText");
const descText = document.getElementById("descText");
const upcText = document.getElementById("upcText");
const assignPanel = document.getElementById("assignPanel");
const assignUpc = document.getElementById("assignUpc");
const statusText = document.getElementById("statusText");

let reader = new BrowserMultiFormatReader();
let controls;
let lastUPC="";

const STORE_KEY="meat_spot_db";
let db = JSON.parse(localStorage.getItem(STORE_KEY)||"{}");

function log(m){statusText.textContent="Status: "+m}

function showFound(upc){
  let v=db[upc];
  spotText.textContent="SPOT "+v.spot+v.zone;
  descText.textContent=v.desc||"";
  upcText.textContent="UPC: "+upc;
  assignPanel.style.display="none";
}

function showAssign(upc){
  spotText.textContent="NOT FOUND";
  descText.textContent="Assign location below";
  upcText.textContent="UPC: "+upc;
  assignUpc.textContent="UPC: "+upc;
  assignPanel.style.display="block";
  lastUPC=upc;
}

window.saveAssign=function(){
  db[lastUPC]={
    spot:spotSel.value,
    zone:zoneSel.value,
    desc:descInput.value
  };
  localStorage.setItem(STORE_KEY,JSON.stringify(db));
  showFound(lastUPC);
  log("Saved location");
}

window.startScan=async function(){
  log("Starting camera...");
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;

  controls=await reader.decodeFromVideoDevice(null,video,(result)=>{
    if(result){
      let upc=result.getText().replace(/\D/g,"");
      if(!upc) return;
      if(db[upc]) showFound(upc);
      else showAssign(upc);
      log("Scanning...");
    }
  });
}

window.stopScan=function(){
  try{controls.stop()}catch{}
  log("Stopped");
}
</script>
</body>
</html>
